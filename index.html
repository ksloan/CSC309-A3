<html>
<head>
	<title>My Favourite Things</title>
	<script src="js/jquery-1.9.0.min.js" type="text/javascript"></script>
	<script src="js/jquery.mobile-1.3.0-rc.1.js" type="text/javascript"></script>
	<link rel="stylesheet" href="css/jquery.mobile-1.3.0-rc.1.css">
	<link rel="stylesheet" href="css/custom.css">
	<!-- initialize website with right dimensions on mobile phones -->
	<!-- add user-scalable=0; to content to remove mobile scaling -->
	<meta name="viewport" content="width=device-width; initial-scale=1.0;">

	
</head>
<body>
	<div data-role="header"><h1>My Favourite Things</h1></div>
	<div data-role="content" id="main">
		<div id="items" class="ui-grid-a">
			<!-- main content goes here-->
		</div> <!-- add class .ui-responsive to use preset breakpoints -->
	</div>
</body>

<script type="text/javascript">

	// Future Config
	var TWEETS_PER_PAGE = 20;

	//Populate the tweets make this a function called loadMoreTweets(startingIndex, TWEETS_PER_PAGE) 
	var currentFavIndex = 0;
	var i = 0;	//only for counting even/odd tweets for now

	$.getJSON('favs.json', function (data) {
		var column;
          	
		//load the tweets (right now it loads all of them)
 		$.each(data, function () {
 			 		       
	        //column switches from a-b for large screen grid view
	        if (i % 2 === 0) {
	        	column = 'a'; 
	       	} else {
	       		column = 'b';	
	       	}

            tweet = this;
   
            var text, name, screen_name, profile_image_url;

			name=tweet.user.name;
			screen_name=tweet.user.screen_name;
			profile_image_url=tweet.user.profile_image_url;
			//update text with all in-tweet links
			text = processEntities(tweet);
			
			var location, description, url;
			location=tweet.user.location;
			description=tweet.user.description;
			user_url=tweet.user.url;
			
			
			
			
            var shtml='';    

			shtml=shtml+'<div class="tweet ui-block-'+column+'">';
            shtml=shtml+'	<img class="profile_image" src="'+profile_image_url+'" />';
            shtml=shtml+'	<span class="name">'+name+'</span>';
            shtml=shtml+'	<span class="screen_name">@'+screen_name+'</span><br>';
            shtml=shtml+'	<span class="text">'+text+'</span>';
            shtml=shtml+'	<div class="user_info">';
            shtml=shtml+'		<span class="location">'+location+'</span><br>';
            shtml=shtml+'		<span class="description">'+description+'</span><br>';
            shtml=shtml+'		<span class="user_url">'+user_url+'</span>';
            shtml=shtml+'	</div>';;
            shtml=shtml+'</div>';
              
            $('#items').append(shtml);
            
            i++;
        });
        
    });
    
    // Return a string with html <a> tags for corresponding entities in the tweet's text
    function processEntities(tweet) {
    	var textArray = tweet.text.split("");
    	
    	var url, hashtag, user_mention, media, start, end;
    	
    	//add links -- opens in external window
    	$.each(tweet.entities.urls, function() {
    		url = this;
    		start = url.indices[0];
    		end = url.indices[1];
    		
    		textArray[start] = '<a href="'+url.url+'" target="_blank">'+textArray[start];
    		
    		//check if the link is at the end of the text to avoid underfined error
    		if (textArray[end]) {
    			textArray[end] = textArray[end]+'</a>';
    		} else {
    			textArray[end] = '</a>';
    		}
    		
      	});
    	
    	//TODO: user mentions -- opens user profile in external window
    	$.each(tweet.entities.user_mentions, function() {
    		user_mention = this;
    		start = user_mention.indices[0];
    		end = user_mention.indices[1];
    		
    		textArray[start] = '<a href="http://twitter.com/'+user_mention.screen_name+'" target="_blank">'+textArray[start];
    		
    		//check if the user_mention is at the end of the text to avoid underfined error
    		if (textArray[end]) {
    			textArray[end] = textArray[end]+'</a>';
    		} else {
    			textArray[end] = '</a>';
    		}
    	});
    	
    	
    	//add hashtags -- opens twitter hashtag search in external window
    	$.each(tweet.entities.hashtags, function () {
    		hashtag = this;
    		start = hashtag.indices[0];
    		end = hashtag.indices[1];
    		
    		textArray[start] = '<a href="https://twitter.com/search/realtime?q=%23'+hashtag.text+'" target="_blank">'+textArray[start];
    				
    		//check if the hashtag is at the end of the text to avoid underfined error
    		if (textArray[end]) {
    			textArray[end] = textArray[end]+'</a>';
    		} else {
    			textArray[end] = '</a>';
    		}
    	});
    	
    	//add links to media (ex. images) -- TODO: render these in a in-browser popup soon
    	//only some tweets have entities.media in the JSON
    	if (tweet.entities.media) {
	    	$.each(tweet.entities.media, function () {
	    		media = this;
	    		start = media.indices[0];
	    		end = media.indices[1];
	    		
	    		textArray[start] = '<a href="'+media.url+'" target="_blank">'+textArray[start];
				
				//check if the hashtag is at the end of the text to avoid underfined error
	    		if (textArray[end]) {
	    			textArray[end] = textArray[end]+'</a>';
	    		} else {
	    			textArray[end] = '</a>';
	    		}
	    	});
    	}
 
    	return textArray.join('');
    }
    
	$(document).ready(function(){
		//use .on() instead of .click() when selecting a dynamically generated DOM element
		
		//toggle between showing user info and tweer when profile picture is clicked
    	$(document).on("click", ".tweet .profile_image", function() {
    		var textElement = $(this).parent().find(".text");
    		var userInfo = $(this).parent().find(".user_info")

    		if (textElement.css("display") == "inline") {
	    		textElement.fadeToggle(200, function() {
	    			userInfo.fadeToggle(200);
	    		});
	    	} else {
	    		userInfo.fadeToggle(200, function() {
	    			textElement.fadeToggle(200);
	    		});
	    	}
		});
		
		
	});
</script>
</html>
